# Dockerized Tor Relay Node on Raspberry Pi
#
# VERSION               0.0.2

FROM debian:bullseye
ARG proxy=""
RUN test -z "$proxy" ||  echo "Acquire { Retries \"0\"; HTTP { Proxy \"$proxy\"; };}; " | tee /etc/apt/apt.conf.d/30proxy
MAINTAINER darius BERNARD
EXPOSE 80
# Install dependencies
RUN apt-get update 
RUN apt-get -y install \
    sane-utils \
    hplip \
    unzip \
    imagemagick \
    usbutils \
    tesseract-ocr \
    tesseract-ocr-eng \
    apache2 \
    libapache2-mod-php \
    coreutils \
    php \
    php-json \
    php-curl \
    tar \
    zip \
    php-fpdf \ 
    libpaper-utils \
    sed \
    grep \
    libusb-1.0-0-dev

RUN apt-get clean

RUN mkdir -p /tmp/
#RUN wget -O /tmp/PHP-Scanner-Server.zip "https://github.com/GM-Script-Writer-62850/PHP-Scanner-Server/archive/master.zip"
ADD https://github.com/GM-Script-Writer-62850/PHP-Scanner-Server/archive/master.zip /tmp/PHP-Scanner-Server.zip
RUN unzip -q /tmp/PHP-Scanner-Server.zip -d /tmp
RUN ls /tmp/
RUN mv /tmp/PHP-Scanner-Server-master/* /var/www/html

# remove original index.html so the PHP page shows up
RUN rm /var/www/html/index.html

RUN adduser www-data lp && \
    mkdir -p /var/www/html/scans && \
    mkdir -p /var/www/html/config/parallel && \
    sed -i 's/max_execution_time.*/max_execution_time = 180/' /etc/php/7.4/apache2/php.ini && \
    sed -i 's/default_socket_timeout.*/default_socket_timeout = 180/' /etc/php/7.4/apache2/php.ini && \
    chown www-data /var/www/html/scans && \
    chown -R www-data /var/www/html/config

RUN a2enmod headers
RUN echo "ServerName scanner.local" >> /etc/apache2/sites-available/000-default.conf

# Add launcher
ADD start.sh /start.sh


# Start scan service(s)
CMD /start.sh
